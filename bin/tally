#!/bin/bash

# This program is free software. It comes without any warranty, to the
# extent permitted by applicable law. You can redistribute it and/or modify
# it under the terms of the Do What The Fuck You Want To Public License,
# Version 2, as published by Sam Hocevar. See WTFPL.txt or
# http://www.wtfpl.net/ for more details.

real_path="$(readlink -f "${0}")" \
  || fail "Failed to get real path to executable."
main_dir="${real_path%/*}/.." \
  || fail "Failed to get absolute path of main directory."
lib_dir="${main_dir}/lib"

libs=(
  "config"
  "io"
  "tally"
  "new_food"
  "serving_points"
  "weigh_in"
  "sync_state"
)

for lib in "${libs[@]}"; do
  source "${lib_dir}/${lib}"
done

sync_state

if test -e "${weigh_in}"; then
  read weight < "${weigh_in}"
  weight="$(distill "${weight}")"
  output "Today's weight:" "${weight}"
else
  output 'Weight not recorded for today.'
  prompt "Weigh in?  [y,N]"
  read response
  if grep -qi 'y' <<< "${response}"; then
    weigh_in
  fi
fi

tally=0
if [ -f "${log}" ]
then
  output "You have a tab for ${date}."
  prompt "[c]ontinue or [o]verwrite? [C,o]"
  read reply
  if grep -qi "^o" <<< "${reply}"; then
    output "Overwriting your old tab."
    > "${log}"
  else
    output "Continuing your old tab."
    tally="$(NONINTERACTIVE='y' tally < "${log}")" \
      || fail "Failed to tally existing tab."
    output
  fi
fi

output "Tally:" "${tally}"
tally

sync_state
